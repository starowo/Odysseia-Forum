# 智能搜索排序算法说明

## 概述

我们设计了一个综合考虑**时间新鲜度**、**标签质量**和**受欢迎程度**的智能混合权重排序算法，用于优化论坛搜索结果的排序。这个算法可以有效地将高质量内容排在前面，同时对差评过多的内容进行降权处理。

## 核心算法

### 1. 时间权重 (Time Weight)

**公式：** `time_weight = exp(-decay_rate × days_since_active)`

- 基于指数衰减函数，模拟内容新鲜度的自然衰减
- `decay_rate` 默认为 0.1（约7天半衰期）
- 越近期活跃的帖子权重越高
- 权重范围：0-1

### 2. 标签权重 (Tag Weight)

**算法：** Wilson Score Lower Bound

**公式：**
```
p = upvotes / total_votes
wilson_center = (p + z²/2n) / (1 + z²/n)
wilson_radius = z × √[(p(1-p) + z²/4n)/n] / (1 + z²/n)
tag_weight = max(0, wilson_center - wilson_radius)
```

其中：
- `z = 1.96` (95%置信区间)
- `n = total_votes` (总评价数)
- `p = positive_rate` (点赞率)

**特点：**
- 更保守的评估方式，考虑样本量置信度
- 评价少的内容不会获得过高评分
- 权重范围：0-1
- 无评价时默认给予 0.5 分

### 3. 反应权重 (Reaction Weight)

**公式：** `reaction_weight = min(1.0, log(reaction_count + 1) / log(base + 1))`

**参数：**
- `base` 默认为 50（对数归一化基数）
- `reaction_count` 为帖子的最高反应数（0-200+）

**特点：**
- 使用对数函数避免极值影响
- 反应数越高权重越大，但增长放缓
- 权重范围：0-1
- 无反应时权重为 0

### 4. 综合评分 (Final Score)

**基础评分：** `base_score = α × time_weight + β × tag_weight + γ × reaction_weight`

**默认权重：**
- 时间权重因子 α = 0.5 (50%)
- 标签权重因子 β = 0.3 (30%)
- 反应权重因子 γ = 0.2 (20%)

### 5. 恶评惩罚机制

对标签评分过低的内容进行额外降权：

- **严重惩罚：** tag_weight < 0.2 且 votes ≥ 5
  - 惩罚系数：0.1 (降至原评分的10%)
  
- **轻度惩罚：** tag_weight < 0.35 且 votes ≥ 10
  - 惩罚系数：0.5 (降至原评分的50%)

**最终评分：** `final_score = base_score × penalty_factor`

## 算法优势

### 1. 科学性
- **Wilson Score** 是统计学上成熟的置信区间算法
- **指数衰减** 符合信息价值随时间自然衰减的规律
- 权重可配置，适应不同社区需求

### 2. 公平性
- 不会因为评价数量少而过分惩罚新内容
- 考虑了样本量对评分可信度的影响
- 防止刷票行为影响排序

### 3. 实用性
- 差评内容自动沉底，提升用户体验
- 时间和质量平衡，既保证新鲜度又维护质量
- 可视化权重信息，用户了解排序依据

## 配置参数

### 权重配置
- `TIME_WEIGHT_FACTOR`: 时间权重因子 (0-1)
- `TAG_WEIGHT_FACTOR`: 标签权重因子 (0-1)
- `REACTION_WEIGHT_FACTOR`: 反应权重因子 (0-1)
- `TIME_DECAY_RATE`: 时间衰减率 (0.01-0.5)

### 反应数处理
- `REACTION_LOG_BASE`: 反应数对数基数 (10-200)
- `MAX_REACTION_SCORE`: 反应权重最大值 (1.0)

### 惩罚机制
- `SEVERE_PENALTY_THRESHOLD`: 严重惩罚阈值 (0-1)
- `MILD_PENALTY_THRESHOLD`: 轻度惩罚阈值 (0-1)
- `SEVERE_PENALTY_FACTOR`: 严重惩罚系数
- `MILD_PENALTY_FACTOR`: 轻度惩罚系数

### Wilson Score
- `WILSON_CONFIDENCE_LEVEL`: 置信水平 (1.96 = 95%)
- `DEFAULT_TAG_SCORE`: 无评价时默认评分 (0.5)

## 预设配置方案

### 1. 平衡配置 (默认)
- 时间权重：50%，标签权重：30%，反应权重：20%
- 适合大多数社区的均衡需求

### 2. 偏重时间新鲜度
- 时间权重：60%，标签权重：20%，反应权重：20%
- 更慢的时间衰减，适合快节奏社区

### 3. 偏重内容质量
- 时间权重：30%，标签权重：50%，反应权重：20%
- 更快的时间衰减，适合质量导向社区

### 4. 偏重受欢迎程度
- 时间权重：30%，标签权重：20%，反应权重：50%
- 更敏感的反应数评分，适合互动性强的社区

### 5. 严格质量控制
- 时间权重：40%，标签权重：40%，反应权重：20%
- 更严格的惩罚机制，适合高质量要求的社区

## 使用方法

### 管理员配置
```
/排序算法配置 preset:平衡配置
/排序算法配置 time_weight:0.4 tag_weight:0.3 reaction_weight:0.3
/排序算法配置 reaction_log_base:30
/查看排序配置
```

### 搜索结果显示
每个搜索结果都会显示：
- 📊 排序权重百分比
- 🔥⏰⌛ 时间权重状态
- 👍⚖️👎 标签权重状态
- 🎉😊👌😐 反应权重状态
- 👍👎 具体评价数据
- ⚠️ 降权原因说明

## 算法效果

1. **提升用户体验**：优质内容更容易被发现
2. **维护社区质量**：差评内容自动沉底
3. **平衡新旧内容**：既保证时效性又注重质量
4. **透明可理解**：用户可以看到排序依据
5. **灵活可配置**：管理员可根据社区特点调整参数

---

*该算法已在 Odysseia Forum 中实现并测试，可根据实际使用效果进一步优化调整。* 