import { useState, useMemo } from 'react';
import { Search, Filter, SlidersHorizontal, Globe, Hash, Bookmark, Settings, X } from 'lucide-react';
import { ResizableSidebar } from '@/components/ResizableSidebar';
import { Link } from 'react-router-dom';
import { useSearchStore } from '@/features/search/store/searchStore';
import { ThreadCard } from '@/features/threads/components/ThreadCard';
import { ThreadCardSkeleton } from '@/features/threads/components/ThreadCardSkeleton';
import { mockChannels, mockTags, filterThreads, mockThreads } from '@/lib/mockData';
import { isDevelopmentMode } from '@/lib/mockAuth';

export function SearchPage() {
  const {
    query,
    selectedChannel,
    sortMethod,
    tagLogic,
    tagMode,
    tagStates,
    page,
    perPage,
    setQuery,
    setChannel,
    setSortMethod,
    setTagLogic,
    setTagMode,
    toggleTag,
    clearAllTags,
    setPage,
    setPerPage,
    clearFilters,
  } = useSearchStore();

  const [searchInput, setSearchInput] = useState(query);
  const [isLoading] = useState(false);

  // 获取选中的标签
  const includedTags = useMemo(() => {
    const tags: string[] = [];
    tagStates.forEach((state, tag) => {
      if (state === 'included') tags.push(tag);
    });
    return tags;
  }, [tagStates]);

  const excludedTags = useMemo(() => {
    const tags: string[] = [];
    tagStates.forEach((state, tag) => {
      if (state === 'excluded') tags.push(tag);
    });
    return tags;
  }, [tagStates]);

  // 过滤帖子
  const filteredThreads = useMemo(() => {
    return filterThreads({
      query,
      channelId: selectedChannel,
      includeTags: includedTags,
      excludeTags: excludedTags,
      tagLogic,
    });
  }, [query, selectedChannel, includedTags, excludedTags, tagLogic]);

  // 分页
  const totalPages = Math.ceil(filteredThreads.length / perPage);
  const paginatedThreads = filteredThreads.slice((page - 1) * perPage, page * perPage);

  // 处理搜索
  const handleSearch = () => {
    setQuery(searchInput);
  };

  // 处理标签点击
  const handleTagClick = (tag: string) => {
    toggleTag(tag);
  };

  // 获取当前频道名称
  const currentChannelName = useMemo(() => {
    if (!selectedChannel) return '全频道搜索';
    for (const category of mockChannels) {
      const channel = category.channels.find((c) => c.id === selectedChannel);
      if (channel) return channel.name;
    }
    return '未知频道';
  }, [selectedChannel]);

export function SearchPage() {
  return (
    <div className="flex min-h-screen">
      {/* 可调整大小的侧边栏 */}
      <ResizableSidebar defaultWidth={240} minWidth={200} maxWidth={400}>
        <div className="mb-6">
          <h2 className="mb-4 text-lg font-bold text-white">频道列表</h2>
          <div className="space-y-2">
            <div className="flex cursor-pointer items-center gap-2 rounded-lg bg-purple-500/20 px-4 py-2 text-sm font-medium text-purple-300">
              <Globe className="h-4 w-4 flex-shrink-0" />
              <span className="truncate">全频道搜索</span>
            </div>
            <div className="flex cursor-pointer items-center gap-2 rounded-lg px-4 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white">
              <Hash className="h-4 w-4 flex-shrink-0" />
              <span className="truncate">频道 1</span>
            </div>
            <div className="flex cursor-pointer items-center gap-2 rounded-lg px-4 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white">
              <Hash className="h-4 w-4 flex-shrink-0" />
              <span className="truncate">频道 2</span>
            </div>
          </div>
        </div>

        <div>
          <h2 className="mb-4 text-lg font-bold text-white">快捷操作</h2>
          <div className="space-y-2">
            <Link
              to="/follows"
              className="flex w-full items-center gap-2 rounded-lg px-4 py-2 text-left text-sm text-slate-400 hover:bg-slate-800 hover:text-white"
            >
              <Bookmark className="h-4 w-4 flex-shrink-0" />
              <span className="truncate">我的关注</span>
            </Link>
            <button className="flex w-full items-center gap-2 rounded-lg px-4 py-2 text-left text-sm text-slate-400 hover:bg-slate-800 hover:text-white">
              <Settings className="h-4 w-4 flex-shrink-0" />
              <span className="truncate">设置</span>
            </button>
          </div>
        </div>
      </ResizableSidebar>

      {/* 主内容区 */}
      <main className="flex-1">
        {/* 顶部搜索栏 */}
        <header className="sticky top-0 z-10 border-b border-slate-800 bg-slate-950/80 backdrop-blur-lg">
          <div className="p-4">
            <div className="flex items-center gap-3">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400" />
                <input
                  type="search"
                  placeholder="搜索标题、作者或内容..."
                  className="w-full rounded-lg border border-slate-700 bg-slate-900 py-3 pl-10 pr-4 text-white placeholder-slate-400 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/20"
                />
              </div>
              <button className="flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-4 py-3 text-white hover:bg-slate-800">
                <Filter className="h-5 w-5" />
                <span className="hidden md:inline">筛选</span>
              </button>
            </div>

            {/* 筛选器提示 */}
            <div className="mt-3 text-xs text-slate-500">
              高级搜索：<code className="rounded bg-slate-800 px-2 py-1">author:作者</code> ·{' '}
              <code className="rounded bg-slate-800 px-2 py-1">"精确匹配"</code> ·{' '}
              <code className="rounded bg-slate-800 px-2 py-1">-排除</code>
            </div>
          </div>
        </header>

        {/* Banner 区域 */}
        <div className="border-b border-slate-800 bg-gradient-to-r from-purple-900/20 to-pink-900/20 p-8">
          <div className="mx-auto max-w-6xl">
            <h1 className="mb-2 text-3xl font-bold text-white">欢迎使用 Odysseia Forum</h1>
            <p className="text-slate-300">探索精彩内容，发现无限可能</p>
          </div>
        </div>

        {/* 标签筛选区 */}
        <div className="border-b border-slate-800 bg-slate-900/30 p-4">
          <div className="mx-auto max-w-6xl">
            <div className="mb-3 flex items-center justify-between">
              <span className="text-sm font-medium text-slate-400">标签筛选</span>
              <button className="flex items-center gap-2 text-xs text-slate-500 hover:text-slate-300">
                <SlidersHorizontal className="h-4 w-4" />
                标签逻辑: AND
              </button>
            </div>
            <div className="flex flex-wrap gap-2">
              <span className="cursor-pointer rounded-full border border-slate-700 bg-slate-800 px-4 py-1.5 text-sm text-slate-300 hover:border-purple-500 hover:bg-purple-500/20 hover:text-purple-300">
                # 标签1
              </span>
              <span className="cursor-pointer rounded-full border border-slate-700 bg-slate-800 px-4 py-1.5 text-sm text-slate-300 hover:border-purple-500 hover:bg-purple-500/20 hover:text-purple-300">
                # 标签2
              </span>
              <span className="cursor-pointer rounded-full border border-slate-700 bg-slate-800 px-4 py-1.5 text-sm text-slate-300 hover:border-purple-500 hover:bg-purple-500/20 hover:text-purple-300">
                # 标签3
              </span>
            </div>
          </div>
        </div>

        {/* 搜索结果 */}
        <div className="p-6">
          <div className="mx-auto max-w-6xl">
            <div className="mb-4 flex items-center justify-between">
              <p className="text-sm text-slate-400">共 0 条结果</p>
              <select className="rounded-lg border border-slate-700 bg-slate-900 px-3 py-1.5 text-sm text-white">
                <option>相关度</option>
                <option>最新发布</option>
                <option>最近活跃</option>
              </select>
            </div>

            {/* 空状态 */}
            <div className="flex min-h-[400px] items-center justify-center rounded-2xl border border-slate-800 bg-slate-900/30">
              <div className="text-center">
                <Search className="mx-auto mb-4 h-16 w-16 text-slate-600" />
                <h3 className="mb-2 text-xl font-bold text-white">开始搜索</h3>
                <p className="text-slate-400">输入关键词或选择频道开始探索</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
}
